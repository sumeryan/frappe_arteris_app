{% extends "templates/web.html" %}

{% block title %}Contract Value Comparison{% endblock %}

{% block head_include %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    /* Reset and override Frappe styles */
    .page-container, .container-fluid {
        padding: 0 !important;
        margin: 0 !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    .page-content {
        background-color: #f8f9fa !important;
        padding: 20px !important;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    .custom-container {
        max-width: 1200px !important;
        margin: 0 auto !important;
        background: white !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
        padding: 30px !important;
        border: none !important;
    }
    
    .custom-header {
        /* Remove border-bottom */
        border-bottom: none !important;
        padding-bottom: 20px !important;
        margin-bottom: 30px !important;
    }
    
    .custom-header h1 {
        color: #2c3e50 !important;
        margin: 0 !important;
        font-size: 28px !important;
        font-weight: bold !important;
    }
    
    .custom-header p {
        color: #6c757d !important;
        margin: 5px 0 0 0 !important;
    }
    
    .custom-filters-section {
        background-color: #f8f9fa !important;
        border-radius: 6px !important;
        padding: 20px !important;
        margin-bottom: 30px !important;
    }
    
    .custom-filters-row {
        display: flex !important;
        gap: 20px !important;
        flex-wrap: wrap !important;
    }
    
    .custom-filter-group {
        flex: 1 !important;
        min-width: 200px !important;
    }
    
    .custom-filter-group label {
        display: block !important;
        margin-bottom: 5px !important;
        font-weight: 600 !important;
        color: #495057 !important;
    }
    
    .custom-filter-group select,
    .custom-filter-group input {
        width: 100% !important;
        padding: 8px 12px !important;
        border: 1px solid #ced4da !important;
        border-radius: 4px !important;
        font-size: 14px !important;
        box-sizing: border-box !important;
    }
    
    .custom-btn {
        background-color: #007bff !important;
        color: white !important;
        border: none !important;
        padding: 10px 20px !important;
        border-radius: 4px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        margin-top: 20px !important;
    }
    
    .custom-btn:hover {
        background-color: #0056b3 !important;
    }
    
    .custom-chart-container {
        position: relative !important;
        height: 400px !important;
        margin-bottom: 30px !important;
    }
    
    .custom-stats-grid {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important;
        gap: 20px !important;
        margin-bottom: 30px !important;
    }
    
    .custom-stat-card {
        background-color: #f8f9fa !important;
        padding: 20px !important;
        border-radius: 6px !important;
        text-align: center !important;
        border-left: 4px solid #007bff !important;
    }
    
    .custom-stat-card h3 {
        margin: 0 0 10px 0 !important;
        color: #495057 !important;
        font-size: 14px !important;
        text-transform: uppercase !important;
    }
    
    .custom-stat-card .value {
        font-size: 24px !important;
        font-weight: bold !important;
        color: #2c3e50 !important;
    }
    
    .custom-data-table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin-top: 20px !important;
        border: none !important;
        box-shadow: none !important;
    }
    
    .custom-data-table th,
    .custom-data-table td {
        padding: 12px !important;
        text-align: left !important;
        border-bottom: 1px solid #dee2e6 !important;
        border-top: none !important;
        border-left: none !important;
        border-right: none !important;
    }
    
    .custom-data-table th {
        background-color: #f8f9fa !important;
        font-weight: 600 !important;
        color: #495057 !important;
        border: none !important;
    }
    
    .custom-data-table tr {
        border: none !important;
    }
    
    .custom-data-table tr:hover {
        background-color: #f8f9fa !important;
        border: none !important;
    }
    
    .currency {
        font-weight: 600 !important;
    }
    
    .positive {
        color: #28a745 !important;
    }
    
    .negative {
        color: #dc3545 !important;
    }
    
    .custom-loading {
        text-align: center !important;
        padding: 20px !important;
        color: #6c757d !important;
    }
    
    #contract-checkbox-list label, #item-checkbox-list label {
        display: flex !important;
        align-items: center !important;
        gap: 6px;
        margin-bottom: 2px;
    }
</style>
{% endblock %}

{% block page_content %}
<div class="custom-container">
    <div class="custom-header">
        <h1>Contract Value Comparison</h1>
        <p>Track planned vs actual spending for contract items over time</p>
    </div>
    
    <div class="custom-filters-section">
        <div class="custom-filters-row">
            <div class="custom-filter-group">
                <label for="contract-select">Contracts</label>
                <div id="contract-checkbox-list" style="max-height: 140px; overflow-y: auto; border: 1px solid #ced4da; border-radius: 4px; padding: 6px 8px; background: #fff;">
                    <!-- Contract checkboxes will be populated by JS -->
                </div>
            </div>
            
            <div class="custom-filter-group">
                <label for="item-select">Contract Items</label>
                <div id="item-checkbox-list" style="max-height: 220px; overflow-y: auto; border: 1px solid #ced4da; border-radius: 4px; padding: 6px 8px; background: #fff;">
                    <!-- Item checkboxes will be populated by JS -->
                </div>
            </div>
            
            <div class="custom-filter-group">
                <label for="start-date">Start Date</label>
                <input type="date" id="start-date" value="{{ frappe.utils.today() }}">
            </div>
            
            <div class="custom-filter-group">
                <label for="end-date">End Date</label>
                <input type="date" id="end-date" value="{{ frappe.utils.add_months(frappe.utils.today(), 12) }}">
            </div>
        </div>
        
        <button class="custom-btn" onclick="updateChart()">Apply Filters</button>
    </div>
    
    <div class="custom-stats-grid">
        <div class="custom-stat-card">
            <h3>Total Planned</h3>
            <div class="value currency" id="total-planned">$0</div>
        </div>
        <div class="custom-stat-card">
            <h3>Total Actual</h3>
            <div class="value currency" id="total-actual">$0</div>
        </div>
        <div class="custom-stat-card">
            <h3>Variance</h3>
            <div class="value currency" id="variance">$0</div>
        </div>
        <div class="custom-stat-card">
            <h3>Completion %</h3>
            <div class="value" id="completion">0%</div>
        </div>
    </div>
    
    <div class="custom-chart-container">
        <canvas id="comparisonChart"></canvas>
    </div>
    
    <div class="custom-loading" id="loading" style="display: none;">
        Loading data...
    </div>
    
    <table class="custom-data-table">
        <thead>
            <tr>
                <th>Period</th>
                <th>Planned Value</th>
                <th>Actual Value</th>
                <th>Cumulative Planned</th>
                <th>Cumulative Actual</th>
                <th>Variance</th>
            </tr>
        </thead>
        <tbody id="data-table-body">
            <!-- Data will be populated here -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block script %}
<script>
    // Mock data for development/testing
    const mockData = {
        contractItems: [
            {
                contract: "CONTRACT-001",
                item: "ITEM-001",
                periods: [
                    { period: "2024-01", date: "2024-01-31", planned_value: 15000, actual_value: 14500 },
                    { period: "2024-02", date: "2024-02-29", planned_value: 12000, actual_value: 13200 },
                    { period: "2024-03", date: "2024-03-31", planned_value: 18000, actual_value: 16800 },
                    { period: "2024-04", date: "2024-04-30", planned_value: 20000, actual_value: 22100 },
                    { period: "2024-05", date: "2024-05-31", planned_value: 16000, actual_value: 15400 },
                    { period: "2024-06", date: "2024-06-30", planned_value: 22000, actual_value: 21000 },
                    { period: "2024-07", date: "2024-07-31", planned_value: 19000, actual_value: 20500 },
                    { period: "2024-08", date: "2024-08-31", planned_value: 25000, actual_value: 26300 },
                    { period: "2024-09", date: "2024-09-30", planned_value: 21000, actual_value: 19800 },
                    { period: "2024-10", date: "2024-10-31", planned_value: 17000, actual_value: 18200 },
                    { period: "2024-11", date: "2024-11-30", planned_value: 23000, actual_value: 22400 },
                    { period: "2024-12", date: "2024-12-31", planned_value: 28000, actual_value: 25900 }
                ]
            }
        ]
    };

    let chart;
    let currentData = null;

    function initChart() {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Cumulative Planned',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false
                    },
                    {
                        label: 'Cumulative Actual',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Period'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    function calculateCumulativeData(periods) {
        let cumulativePlanned = 0;
        let cumulativeActual = 0;
        
        return periods.map(period => {
            cumulativePlanned += period.planned_value;
            cumulativeActual += period.actual_value;
            
            return {
                ...period,
                cumulative_planned: cumulativePlanned,
                cumulative_actual: cumulativeActual,
                variance: cumulativeActual - cumulativePlanned
            };
        });
    }

    function updateChart() {
        if (!currentData || !currentData.periods) {
            console.log('No data available');
            return;
        }

        const cumulativeData = calculateCumulativeData(currentData.periods);
        
        // Update chart data
        chart.data.labels = cumulativeData.map(d => d.period);
        chart.data.datasets[0].data = cumulativeData.map(d => d.cumulative_planned);
        chart.data.datasets[1].data = cumulativeData.map(d => d.cumulative_actual);
        chart.update();
        
        // Update statistics
        const totalPlanned = cumulativeData[cumulativeData.length - 1].cumulative_planned;
        const totalActual = cumulativeData[cumulativeData.length - 1].cumulative_actual;
        const variance = totalActual - totalPlanned;
        const completion = ((totalActual / totalPlanned) * 100).toFixed(1);
        
        document.getElementById('total-planned').textContent = '$' + totalPlanned.toLocaleString();
        document.getElementById('total-actual').textContent = '$' + totalActual.toLocaleString();
        document.getElementById('variance').textContent = '$' + variance.toLocaleString();
        document.getElementById('variance').className = 'value currency ' + (variance >= 0 ? 'positive' : 'negative');
        document.getElementById('completion').textContent = completion + '%';
        
        // Update table
        updateTable(cumulativeData);
    }

    function updateTable(data) {
        const tbody = document.getElementById('data-table-body');
        tbody.innerHTML = '';
        
        data.forEach(row => {
            const tr = document.createElement('tr');
            const variance = row.cumulative_actual - row.cumulative_planned;
            
            tr.innerHTML = `
                <td>${row.period}</td>
                <td class="currency">$${row.planned_value.toLocaleString()}</td>
                <td class="currency">$${row.actual_value.toLocaleString()}</td>
                <td class="currency">$${row.cumulative_planned.toLocaleString()}</td>
                <td class="currency">$${row.cumulative_actual.toLocaleString()}</td>
                <td class="currency ${variance >= 0 ? 'positive' : 'negative'}">$${variance.toLocaleString()}</td>
            `;
            
            tbody.appendChild(tr);
        });
    }

    function loadContracts() {
        frappe.call({
            method: 'frappe.client.get_list',
            args: {
                doctype: 'Contract',
                fields: ['name', 'contrato'],
                order_by: 'creation asc',
                limit_page_length: 100,
            },
            callback: function(response) {
                const container = document.getElementById('contract-checkbox-list');
                container.innerHTML = '';
                if (response.message) {
                    response.message.forEach(contract => {
                        const label = document.createElement('label');
                        label.style.display = 'block';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = contract.name;
                        checkbox.className = 'contract-checkbox';
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(' ' + contract.contrato));
                        container.appendChild(label);
                    });
                }
            },
            error: function(error) {
                console.error('Error loading contracts:', error);
                document.getElementById('contract-checkbox-list').innerHTML = '';
            }
        });
    }

    function loadContractItems() {
        const contractCheckboxes = document.querySelectorAll('.contract-checkbox:checked');
        const selectedContracts = Array.from(contractCheckboxes).map(cb => cb.value);
        const container = document.getElementById('item-checkbox-list');
        container.innerHTML = '';
        if (!selectedContracts.length) return;
        frappe.call({
            method: 'frappe.client.get_list',
            args: {
                doctype: 'Contract Item',
                filters: { 'contrato': ["in", selectedContracts] },
                fields: ['name', 'descricao'], 
                order_by: 'creation asc',
                limit_page_length: 100
            },
            callback: function(response) {
                console.log(response)
                const itemsSet = new Set();
                if (response.message) {
                    response.message.forEach(item => {
                        if (!itemsSet.has(item.name)) {
                            itemsSet.add(item.name);
                            const label = document.createElement('label');
                            label.style.display = 'block';
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = item.name;
                            checkbox.className = 'item-checkbox';
                            label.appendChild(checkbox);
                            label.appendChild(document.createTextNode(item.descricao));
                            container.appendChild(label);
                        }
                    });
                }
            },
            error: function(error) {
                console.error('Error loading contract items:', error);
                container.innerHTML = '';
            }
        });
    }

    // Initialize the page when Frappe is ready
    frappe.ready(function() {
        initChart();
        loadContracts();
        
        // Load mock data initially
        currentData = mockData.contractItems[0];
        updateChart();
        
        // Add event listeners for filters
        document.getElementById('contract-checkbox-list').addEventListener('change', function(e) {
            if (e.target.classList.contains('contract-checkbox')) {
                loadContractItems();
            }
        });
        
        document.getElementById('item-checkbox-list').addEventListener('change', function(e) {
            // You can handle item selection here if needed
        });
    });
</script>
{% endblock %}