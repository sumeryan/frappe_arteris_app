{% extends "templates/web.html" %}

{% block title %}Contract Performance Analysis{% endblock %}

{% block head_include %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    .container-fluid {
        max-width: 1200px;
        margin: 0 auto;
        padding: 30px 15px;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e9ecef;
    }
    .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }
    .filters-section {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .filter-group label {
        font-weight: 500;
        color: #495057;
        font-size: 14px;
    }
    .filter-group select, .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }
    .filter-group select:focus, .filter-group input:focus {
        outline: none;
        border-color: #5e72e4;
        box-shadow: 0 0 0 2px rgba(94, 114, 228, 0.25);
    }
    .btn-primary {
        background-color: #5e72e4;
        border-color: #5e72e4;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }
    .btn-primary:hover {
        background-color: #4c63d2;
        border-color: #4c63d2;
    }
    .btn-primary:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        cursor: not-allowed;
    }
    .chart-section {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .chart-container {
        position: relative;
        height: 500px;
        margin-bottom: 20px;
    }
    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .legend-color {
        width: 20px;
        height: 3px;
        border-radius: 2px;
    }
    .summary-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .summary-card.actual {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .summary-card.variance {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .summary-card h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        opacity: 0.9;
        font-weight: 500;
    }
    .summary-card .value {
        font-size: 28px;
        font-weight: 600;
        margin: 0;
    }
    .loading-spinner {
        text-align: center;
        padding: 50px;
        color: #6c757d;
    }
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
    }
    .last-updated {
        color: #6c757d;
        font-size: 12px;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <h1 class="page-title">Contract Performance Analysis</h1>
        <div id="lastUpdated" class="last-updated"></div>
    </div>
    
    <div class="filters-section">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="contractFilter">Contract:</label>
                <select id="contractFilter" class="form-control">
                    <option value="">All Contracts</option>
                    {% for contract in contracts %}
                    <option value="{{ contract.name }}">{{ contract.nrcontrato or contract.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="yearFilter">Year:</label>
                <select id="yearFilter" class="form-control">
                    <option value="">All Years</option>
                    {% for year in years %}
                    <option value="{{ year }}">{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="startMonth">Start Month:</label>
                <input type="month" id="startMonth" class="form-control">
            </div>
            <div class="filter-group">
                <label for="endMonth">End Month:</label>
                <input type="month" id="endMonth" class="form-control">
            </div>
        </div>
        <div class="text-center">
            <button class="btn btn-primary" onclick="loadChartData()">
                <span id="loadingText">Update Chart</span>
            </button>
        </div>
    </div>
    
    <div id="errorMessage" class="error-message" style="display: none;"></div>
    
    <div class="summary-section">
        <div class="summary-card">
            <h3>Total Planned</h3>
            <p class="value" id="totalPlanned">$0.00</p>
        </div>
        <div class="summary-card actual">
            <h3>Total Actual</h3>
            <p class="value" id="totalActual">$0.00</p>
        </div>
        <div class="summary-card variance">
            <h3>Variance</h3>
            <p class="value" id="variance">$0.00</p>
        </div>
    </div>
    
    <div class="chart-section">
        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>
        <div class="chart-legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #36a2eb;"></div>
                <span>Planned Values (Cumulative)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ff6384;"></div>
                <span>Actual Values (Cumulative)</span>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let chart;
    let plannedData = [];
    let actualData = [];

    // Initialize page
    $(document).ready(function() {
        initializePage();
    });

    function initializePage() {
        loadChartData();
        updateLastUpdated();
    }

    function loadChartData() {
        const loadingText = document.getElementById('loadingText');
        const errorMessage = document.getElementById('errorMessage');
        
        // Show loading state
        loadingText.textContent = 'Loading...';
        document.querySelector('.btn-primary').disabled = true;
        errorMessage.style.display = 'none';

        const contractFilter = document.getElementById('contractFilter').value;
        const yearFilter = document.getElementById('yearFilter').value;
        const startMonth = document.getElementById('startMonth').value;
        const endMonth = document.getElementById('endMonth').value;

        // Build filters
        const filters = [];
        if (contractFilter) filters.push(['contrato', '=', contractFilter]);
        if (yearFilter) filters.push(['ano', '=', parseInt(yearFilter)]);
        if (startMonth) {
            const [year, month] = startMonth.split('-');
            filters.push(['ano', '>=', parseInt(year)]);
            filters.push(['mes', '>=', parseInt(month)]);
        }
        if (endMonth) {
            const [year, month] = endMonth.split('-');
            filters.push(['ano', '<=', parseInt(year)]);
            filters.push(['mes', '<=', parseInt(month)]);
        }

        // Load planned data
        frappe.call({
            method: 'frappe.client.get_list',
            args: {
                doctype: 'Contract Item Workload Cfg',
                fields: ['name', 'contrato', 'mes', 'ano'],
                filters: filters.length > 0 ? filters : [],
                limit_page_length: 0
            },
            callback: function(r) {
                if (r.message) {
                    loadPlannedDetails(r.message);
                } else {
                    showError('Failed to load planned data');
                    resetLoadingState();
                }
            }
        });
    }

    function loadPlannedDetails(plannedRecords) {
        const promises = plannedRecords.map(record => {
            return new Promise((resolve, reject) => {
                frappe.call({
                    method: 'frappe.client.get',
                    args: {
                        doctype: 'Contract Item Workload Cfg',
                        name: record.name
                    },
                    callback: function(r) {
                        if (r.message) {
                            resolve({
                                ...record,
                                tabitens: r.message.tabitens || []
                            });
                        } else {
                            reject(new Error('Failed to load record details'));
                        }
                    }
                });
            });
        });

        Promise.all(promises).then(detailedRecords => {
            processPlannedData(detailedRecords);
            loadActualData();
        }).catch(error => {
            showError('Error loading planned data details: ' + error.message);
            resetLoadingState();
        });
    }

    function loadActualData() {
        const contractFilter = document.getElementById('contractFilter').value;
        const actualFilters = contractFilter ? [['contrato', '=', contractFilter]] : [];

        frappe.call({
            method: 'frappe.client.get_list',
            args: {
                doctype: 'Contract Measurement',
                fields: ['name', 'contrato', 'datainicialmedicao'],
                filters: actualFilters,
                limit_page_length: 0
            },
            callback: function(r) {
                if (r.message) {
                    loadActualDetails(r.message);
                } else {
                    showError('Failed to load actual data');
                    resetLoadingState();
                }
            }
        });
    }

    function loadActualDetails(actualRecords) {
        const promises = actualRecords.map(record => {
            return new Promise((resolve, reject) => {
                frappe.call({
                    method: 'frappe.client.get',
                    args: {
                        doctype: 'Contract Measurement',
                        name: record.name
                    },
                    callback: function(r) {
                        if (r.message) {
                            resolve({
                                ...record,
                                tabitenscontatrato: r.message.tabitenscontatrato || []
                            });
                        } else {
                            reject(new Error('Failed to load record details'));
                        }
                    }
                });
            });
        });

        Promise.all(promises).then(detailedRecords => {
            processActualData(detailedRecords);
            updateChart();
            updateSummaryCards();
            resetLoadingState();
        }).catch(error => {
            showError('Error loading actual data details: ' + error.message);
            resetLoadingState();
        });
    }

    function processPlannedData(plannedRecords) {
        const processedData = new Map();

        plannedRecords.forEach(record => {
            const key = `${record.ano}-${record.mes.toString().padStart(2, '0')}`;
            const totalValue = record.tabitens.reduce((sum, item) => sum + (item.valor || 0), 0);
            
            if (!processedData.has(key)) {
                processedData.set(key, 0);
            }
            processedData.set(key, processedData.get(key) + totalValue);
        });

        // Convert to sorted array and calculate cumulative values
        const sortedEntries = Array.from(processedData.entries()).sort();
        let cumulative = 0;
        
        plannedData = sortedEntries.map(([period, value]) => {
            cumulative += value;
            return {
                x: period,
                y: cumulative
            };
        });
    }

    function processActualData(actualRecords) {
        const processedData = new Map();

        actualRecords.forEach(record => {
            if (record.datainicialmedicao) {
                const date = new Date(record.datainicialmedicao);
                const key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const totalValue = record.tabitenscontatrato.reduce((sum, item) => sum + (item.valortotalvigente || 0), 0);
                
                if (!processedData.has(key)) {
                    processedData.set(key, 0);
                }
                processedData.set(key, processedData.get(key) + totalValue);
            }
        });

        // Convert to sorted array and calculate cumulative values
        const sortedEntries = Array.from(processedData.entries()).sort();
        let cumulative = 0;
        
        actualData = sortedEntries.map(([period, value]) => {
            cumulative += value;
            return {
                x: period,
                y: cumulative
            };
        });
    }

    function updateChart() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        if (chart) {
            chart.destroy();
        }

        // Get all unique periods from both datasets
        const allPeriods = [...new Set([
            ...plannedData.map(d => d.x),
            ...actualData.map(d => d.x)
        ])].sort();

        // Fill missing periods with previous cumulative values
        const fillMissingPeriods = (data) => {
            const result = [];
            let lastValue = 0;
            
            allPeriods.forEach(period => {
                const found = data.find(d => d.x === period);
                if (found) {
                    lastValue = found.y;
                }
                result.push({ x: period, y: lastValue });
            });
            
            return result;
        };

        const filledPlannedData = fillMissingPeriods(plannedData);
        const filledActualData = fillMissingPeriods(actualData);

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Planned Values (Cumulative)',
                    data: filledPlannedData,
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 3
                }, {
                    label: 'Actual Values (Cumulative)',
                    data: filledActualData,
                    borderColor: '#ff6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'category',
                        title: {
                            display: true,
                            text: 'Time Period (YYYY-MM)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        grid: {
                            display: true,
                            color: '#e9ecef'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Value ($)',
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            display: true,
                            color: '#e9ecef'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Contract Performance: Planned vs Actual Values Over Time',
                        font: {
                            size: 18,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 30
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    function updateSummaryCards() {
        const totalPlanned = plannedData.length > 0 ? plannedData[plannedData.length - 1].y : 0;
        const totalActual = actualData.length > 0 ? actualData[actualData.length - 1].y : 0;
        const variance = totalActual - totalPlanned;

        document.getElementById('totalPlanned').textContent = formatCurrency(totalPlanned);
        document.getElementById('totalActual').textContent = formatCurrency(totalActual);
        document.getElementById('variance').textContent = formatCurrency(variance);
    }

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function resetLoadingState() {
        document.getElementById('loadingText').textContent = 'Update Chart';
        document.querySelector('.btn-primary').disabled = false;
    }

    function updateLastUpdated() {
        const now = new Date();
        document.getElementById('lastUpdated').textContent = 
            'Last updated: ' + now.toLocaleString();
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(amount);
    }
</script>
{% endblock %}