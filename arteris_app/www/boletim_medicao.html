<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boletim de Medição</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Calibri, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            max-width: 100%;
        }

        .table-wrapper {
            display: flex;
            overflow: hidden;
        }

        .fixed-columns {
            flex-shrink: 0;
            border-right: 2px solid #ddd;
            background: #fafafa;
        }

        .scrollable-columns {
            flex: 1;
            overflow-x: auto;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }

        .fixed-table {
            width: 800px;
        }

        .scrollable-table {
            min-width: max-content;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }

        th {
            background-color: #A9B5B7;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .fixed-columns th {
            background-color: #002D47;
        }

        .measurement-header {
            background-color: #002D47;
            text-align: center;
            font-size: 11px;
            padding: 6px;
        }

        .sub-header {
            background-color: #002D47;
            opacity: 0.8;
            font-size: 10px;
            text-align: center;
        }

        .item-code {
            font-weight: bold;
            color: #002D47;
        }

        .item-desc {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .numeric {
            text-align: right;
            font-family: 'Calibri';
        }

        .total-row {
            background-color: #002D47;
            color: #fff;
            font-weight: bold;
            opacity: 0.8;
        }

        .level-1 {
            background-color: rgba(251, 72, 20, 0.2);
            color: #424156;
            font-weight: bold;
        }
        .level-2 {
            background-color: rgba(102, 255, 0, 0.2);
            color: #424156;
            font-weight: bold;
        }
        .level-3 {
            background-color: rgba(0, 45, 71, 0.2);
            color: #38393D;
            font-weight: bold;
        }
        .level-4 {
            background-color: rgba(0, 146, 101, 0.2);
            color: #38393D;
        }

        .scrollable-columns::-webkit-scrollbar {
            height: 8px;
        }

        .scrollable-columns::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .scrollable-columns::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .scrollable-columns::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .scrollable-tables-wrapper {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            overflow-x: auto;
        }

        .scrollable-table-container {
            flex: 1;
            min-width: 450px;
        }

        .document-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            color: #38393D;
        }

        .logo-container {
            width: 100%;
            text-align: center;
        }

        .logo {
            max-width: 200px;
            height: auto;
        }

        .header-title {
            width: 100%;
            text-align: center;
            color: #38393D;
        }

        .info-boxes-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
            width: 100%;
        }

        .info-box {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .info-box-title {
            font-size: 14px;
            color: #002D47;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .info-box-value {
            font-size: 18px;
            color: #002D47;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="document-header">
        <div class="logo-container">
            <img src="https://www.arteris.com.br/static/icons/arteris-logo.dc5c9168a8a3.svg" alt="Logo" class="logo">
        </div>
        <div class="header-title">
            <h1>Boletim de Medição</h1>
        </div>
    </div>

    <div class="info-boxes-container">
        <div class="info-box">
            <div class="info-box-title">Valor Total Vigente</div>
            <div class="info-box-value" id="valor-total-vigente">Carregando...</div>
        </div>
        <div class="info-box">
            <div class="info-box-title">Medição Atual Acumulada</div>
            <div class="info-box-value" id="medicao-acumulada">Carregando...</div>
        </div>
        <div class="info-box">
            <div class="info-box-title">Medição Atual Acumulada (%)</div>
            <div class="info-box-value" id="medicao-percentual">Carregando...</div>
        </div>
    </div>

    <div class="table-container">
        <div class="table-wrapper">
            <!-- Fixed Columns -->
            <div class="fixed-columns">
                <table class="fixed-table">
                    <thead>
                        <tr>
                            <th rowspan="3">Item</th>
                            <th rowspan="3">Descrição</th>
                            <th rowspan="3">Und.</th>
                            <th colspan="3" class="measurement-header">Planilha Contratual</th>
                        </tr>
                        <tr>
                            <th colspan="3" class="sub-header">-</th>
                        </tr>
                        <tr>
                            <th>Quant.</th>
                            <th>Valor Unitário</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody id="fixed-table-body">
                        <tr class="loading">
                            <td colspan="6">Carregando dados...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Scrollable Columns -->
            <div class="scrollable-columns" id="scrollable-columns">
                <div class="loading">Carregando medições...</div>
            </div>
        </div>
    </div>

    <script>
        // Frappe Custom Page JavaScript
        frappe.pages['boletim-medicao'].on_page_load = function(wrapper) {
            var page = frappe.ui.make_app_page({
                parent: wrapper,
                title: 'Boletim de Medição',
                single_column: true
            });
            
            // Move the body content to the page wrapper
            page.main.html(document.body.innerHTML);
            
            // Load data when page loads
            loadMeasurementData();
        };

        // Utility functions for formatting (similar to your Python functions)
        function formatCurrency(value) {
            if (!value) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(dateString, showMonth = false) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (showMonth) {
                return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            }
            return date.toLocaleDateString('pt-BR');
        }

        function formatZeroValues(value) {
            if (!value || value === 0) return '';
            return value.toLocaleString('pt-BR');
        }

        // Function to load data from Frappe
        function loadMeasurementData() {
            // TODO: Replace with actual Frappe API calls
            // This is where you'll call your Frappe doctypes
            
            // Example structure for data loading:
            /*
            frappe.call({
                method: 'your_app.api.get_measurement_data',
                callback: function(r) {
                    if (r.message) {
                        populateData(r.message);
                    }
                }
            });
            */
            
            // For now, using sample data
            const sampleData = {
                valor_total_contrato: 1000000,
                medicaoacumulada: 750000,
                medicao_atual_acumulada_percentual: 75,
                contract_items_list: [
                    {
                        codigo: '001',
                        descricao: 'Serviços de Engenharia',
                        unidade: 'UN',
                        quantidade: 10,
                        valorunitario: 50000,
                        valortotalvigente: 500000,
                        level: 1
                    }
                ],
                contract_measurement_list: []
            };
            
            populateData(sampleData);
        }

        function populateData(data) {
            // Update info boxes
            document.getElementById('valor-total-vigente').textContent = formatCurrency(data.valor_total_contrato);
            document.getElementById('medicao-acumulada').textContent = formatCurrency(data.medicaoacumulada);
            document.getElementById('medicao-percentual').textContent = formatZeroValues(data.medicao_atual_acumulada_percentual) + '%';
            
            // Populate fixed table
            generateContractItemsList(data.contract_items_list);
            
            // Populate scrollable tables
            generateScrollableTableList(data.contract_measurement_list);
        }

        function generateContractItemsList(items) {
            const tbody = document.getElementById('fixed-table-body');
            let html = '';
            
            items.forEach(item => {
                html += `
                    <tr class="level-${item.level}">
                        <td class="item-code">${item.codigo}</td>
                        <td class="item-desc" title="${item.descricao}">${item.descricao}</td>
                        <td>${item.unidade || ''}</td>
                        <td class="numeric">${formatZeroValues(item.quantidade)}</td>
                        <td class="numeric">${formatCurrency(item.valorunitario)}</td>
                        <td class="numeric">${formatCurrency(item.valortotalvigente)}</td>
                    </tr>
                `;
            });
            
            // Add total row
            html += `
                <tr class="total-row">
                    <td colspan="5">Total</td>
                    <td class="numeric">${formatCurrency(1000000)}</td>
                </tr>
            `;
            
            tbody.innerHTML = html;
        }

        function generateScrollableTableList(tableData) {
            const container = document.getElementById('scrollable-columns');
            
            if (!tableData || tableData.length === 0) {
                container.innerHTML = '<div class="loading">Nenhuma medição encontrada</div>';
                return;
            }
            
            let periodsHtml = '';
            
            tableData.forEach(periodData => {
                const periodMonth = periodData.datafinalmedicao;
                const payFactorExists = periodData.pay_factor_exist;
                
                let itemsHtml = '';
                periodData.tabitenscontatrato.forEach(data => {
                    const payFactorColumn = payFactorExists ? 
                        `<td colspan="2">${formatZeroValues(data.valorfatorpagamento)}</td>` : '';
                    
                    itemsHtml += `
                        <tr class="level-${data.level}">
                            <td>${formatZeroValues(data.quantidademedida)}</td>
                            <td>${formatZeroValues(data.quantidadetotalvigente)}</td>
                            <td>${formatCurrency(data.valortotalmedido)}</td>
                            <td>${formatCurrency(data.valortotalvigente)}</td>
                            ${payFactorColumn}
                        </tr>
                    `;
                });
                
                const payFactorHeader = payFactorExists ? 
                    '<th colspan="2" class="sub-header">Pay factor</th>' : '';
                const payFactorSubHeader = payFactorExists ? 
                    '<th colspan="2" class="sub-header"></th>' : '';
                
                periodsHtml += `
                    <div class="scrollable-table-container">
                        <table class="scrollable-table">
                            <thead>
                                <tr>
                                    <th colspan="6" class="measurement-header">Período: ${formatDate(periodMonth, true)}</th>
                                </tr>
                                <tr>
                                    <th colspan="2" class="sub-header">Quantidades</th>
                                    <th colspan="2" class="sub-header">Valores (R$)</th>
                                    ${payFactorHeader}
                                </tr>
                                <tr>
                                    <th class="sub-header">No Mês</th>
                                    <th class="sub-header">Acumulado</th>
                                    <th class="sub-header">No Mês</th>
                                    <th class="sub-header">Acumulado</th>
                                    ${payFactorSubHeader}
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                                <tr class="total-row">
                                    <td colspan="2"></td>
                                    <td class="numeric">${formatCurrency(periodData.valor_total_periodo || 0)}</td>
                                    <td class="numeric">${formatCurrency(periodData.valor_total_acumulado || 0)}</td>
                                    ${payFactorExists ? '<td class="numeric"></td>' : ''}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            container.innerHTML = `<div class="scrollable-tables-wrapper">${periodsHtml}</div>`;
        }
    </script>
</body>
</html>